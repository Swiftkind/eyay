{% extends '../base.html' %}
{% load staticfiles %}
{% block title %} {{ bot.name }} Details {% endblock %}

{% block header %}
<div class="collections">
  <div class="container">
    <div class="row">
      <div class="col-xs-12 col-md-9">
        <div class="col-md-offset-1">
          <h1 class="title">{{ bot.name }}</h1>
          <p class="total-bots">{{ bot.category }}</p>
        </div>
      </div>
      <div class="col-xs-12 col-md-2">
        <a href="{% url 'chat' bot.id %}" class="btn btn-primary new_bot-btn ">Start Chat</a>
      </div>
    </div>

    <div class="row">
      <div class="col-xs-12 col-md-10">
        <div class="col-md-offset-1">
          <h5 class="information-header sign">
            <span class="glyphicon glyphicon-info-sign info-sign"></span> &nbsp; Details <span> <a onclick="editbotPopUp()" class="edit-link"> Edit </a></span></h5> <br>
          </div>
        </div>
      </div>
      <div class="container">
        <div class="col-xs-12 col-md-10 ">
          <div class="col-md-offset-1">
           <div class="header-divider">
            <p class="bot-description ">
              {{ bot.description }}
            </p> 
          </div>
        </div>
      </div>
    </div>
    {% if request.user.is_authenticated %}
    <div class="col-md-11 col-sm-12">
      <div class="col-md-offset-2 col-sm-offset-2">
        <form class="custom-form" id="editbotForm" style="display: none;">
          <div class="row">
            <div class="custom-questions">
              What do you want to call your bot?
            </div> 
            <input type="text" class="form-control" id="name" value="{{ bot.name }}" autofocus required>
          </div>
          <div class="row">
            <div class="custom-questions">
              Please select a category for you bot: 
            </div> 
            <input type="text" class="form-control" id="category" value="{{ bot.category }}" required>
          </div>
          <div class="row">
            <div class="custom-questions">
              Describe your bot:
            </div> 
            <input type="text" class="form-control" id="description" value="{{ bot.description }}">
          </div>
          <div class="row">
            <div class="custom-questions">
              Tags
            </div> 
            <input type="text" class="form-control" id="tags" value="{{ bot.tags }}" data-role="tagsinput">
          </div>
          <div class="row">
            <button type="submit" onclick="editBot()" class="done-btn ">
              Save Edit
            </button>
          </div>
        </form>
      </div>
    </div>
    {% endif %}
  </div>
</div>
{% endblock %}


{% block content %}
<div class="container">
  <nav class="navbar navbar-nav ">
    <div class="container">
      <ul class="nav navbar-nav navbar-right">
        <li class="dropdown">
          <div class="container">
            <ul class="pagination navbar-right pagination-style">
              <li><a href="#">First</a></li>
              <li><a href="#">5</a></li>
              <li class="active"><a href="#">6</a></li>
              <li><a href="#">7</a></li>
              <li><a href="#">Last</a></li>
            </ul>
          </li>
        </ul>
      </div>
    </nav>
  </div>

  <div class="container">
    <div class="row">
      <div class="panel row">
        <div class="col-xs-12 bot-detail-content" >

          <div class="col-md-12 col-xs-12">
            <div class="col-md-offset-1 col-xs-offset-2">
              <div class="row">
                <div class="text-question">
                  Questions
                </div>
              </div>
            </div>
          </div>
          {% if bot_knowledge %}
          {% for knowledge in bot_knowledge %}
          <div class="row">
            <div class="col-xs-12 col-md-11">
              <div class="col-md-offset-1">
                <div class="panel panel-body knowledge-container">
                  <div class="row">
                    <div class="col-md-1 col-sm-1">
                      <span class="question-icon">Q</span> 
                    </div>
                    <div class="col-md-10 col-sm-9">
                      <span class="question">
                        {{ knowledge.statement }}
                      </span> 
                    </div>

                    <div class="col-md-1">
                      <span>
                       <div class="btn-group">
                        <span class="dropdown">
                          <a href="#" class="dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            <span class=" glyphicon glyphicon-option-horizontal "></span></a>
                            <ul class="dropdown-menu">
                              <li><a onclick="editknowledgePopUp({{ knowledge.id }})">Edit</a></li>
                              <li><a href="#" onclick="deleteKnowledge({{ knowledge.id }}); return false;">Delete</a></li>
                            </ul>
                          </span>
                        </div>
                      </span>
                    </div>
                  </div>

                  <div class="row"> 
                    <div class="col-md-8 col-sm-10">
                      <div class="col-md-offset-2 col-sm-offset-2">
                        <p class="answer-word"> Answer:</p>
                      </div>
                    </div>
                  </div>

                  <div class="row">
                    <div class="col-md-11 col-sm-10">
                      <div class="col-md-offset-1 col-sm-offset-2">
                        <p class="answer">
                          {{ knowledge.answer }}
                        </p>
                      </div>
                    </div> 
                  </div>
                  {% if request.user.is_authenticated %}
                <div class="col-md-12 col-xs-12" id="editknowledge{{ knowledge.id }}" style="display: none;">
                  <div class="bot-details-footer">
                    <div class="col-md-offset-1 col-xs-offset-2">
                      <p class="Add-Queries">
                        Edit Query:
                      </p>
                    </div>
                    <div class="col-md-11 col-xs-12">
                      <div class="col-md-offset-2 col-xs-offset-2">
                        <form id="editknowledgeForm{{ knowledge.id }}">
                          <div class="row">
                            <p class="query-label">
                              Question for {{ bot.name }}: 
                            </p>
                            <input type="text" id="editedquestion{{ knowledge.id }}" value="{{ knowledge.statement }}">
                          </div>
                          <div class="row">
                            <p class="query-label">
                              {{ bot.name }}'s Response
                            </p>
                            <input type="text" id="editedanswer{{ knowledge.id }}" value="{{ knowledge.answer }}">
                          </div>
                          <div class="row">
                            <button type="submit" onclick="editKnowledge({{ knowledge.id }})" class="save-query">
                              Save Query
                            </button>
                          </div>
                        </form>
                      </div>
                    </div>
                  </div>
                </div>
                {% endif %}
                </div>
              </div>
            </div>
          </div>
          {% endfor %}
          {% else %}
          <h3>This bot knows nothing. Please Initialize by adding queries.</h3>
          {% endif %}

          {% if request.user.is_authenticated %}
          <div class="col-md-12 col-xs-12">
            <div class="bot-details-footer">
              <div class="col-md-offset-1 col-xs-offset-2">
                <p class="Add-Queries">
                  Add Query:
                </p>
              </div>
              <div class="col-md-11 col-xs-12">
                <div class="col-md-offset-2 col-xs-offset-2">
                  <form id="addknowledgeForm">
                    <div class="row">
                      <p class="query-label">
                        Question for {{ bot.name }}: 
                      </p>
                      <input type="text" id="question" placeholder="e.g. What are you?">
                    </div>
                    <div class="row">
                      <p class="query-label">
                        {{ bot.name }}'s Response
                      </p>
                      <input type="text" id="answer" placeholder="e.g. I am a Customer Support Bot.">
                    </div>
                    <div class="row">
                      <button type="submit" class="save-query">
                        Save Query
                      </button>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>



  {% endblock %}


  {% block js %}
  <script>
    function editbotPopUp() {
      var x = document.getElementById("editbotForm");
      if (x.style.display === "none") {
        x.style.display = "block";
      } else {
        x.style.display = "none";
      }
    } 
  </script>

  
  <script>
    function editknowledgePopUp(knowledge_id) {
      var x = document.getElementById("editknowledge"+ knowledge_id);
      if (x.style.display === "none") {
        x.style.display = "block";
      } else {
        x.style.display = "none";
      }
    } 
  </script>


  <script>
    function editBot(){
      var editbotUrl = '/api/bots/{{ bot.id }}/';
      var botId = '{{ bot.id }}'
      function getCookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie != '') {
          var cookies = document.cookie.split(';');
          for (var i = 0; i < cookies.length; i++) {
            var cookie = jQuery.trim(cookies[i]);
            if (cookie.substring(0, name.length + 1) == (name + '=')) {
              cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
              break;
            }
          }
        }
        return cookieValue;
      }

      $("#editbotForm").on('submit', function(e) {
        e.preventDefault();

        var csrftoken = getCookie('csrftoken');

        function csrfSafeMethod(method) {
      // these HTTP methods do not require CSRF protection
      return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
    }

    $.ajaxSetup({
      beforeSend: function(xhr, settings) {
        if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
          xhr.setRequestHeader("X-CSRFToken", csrftoken);
        }
      }
    });

    var name = $('#name').val();
    var description = $('#description').val();
    var category = $('#category').val();
    var tags = $('#tags').val();
    var params = {
      csrfmiddlewaretoken : csrftoken, 
      name: "" + name, 
      description: "" + description, 
      category: "" + category,  
      tags: "" + tags
    };

    $.ajax({
      type : 'PUT',
      url : editbotUrl,
      data : JSON.stringify(params),
      contentType: 'application/json',
      success : function(json) {
        alert('Bot was successfully edited!');
        window.location = '/bot/' + botId;
      },
      error : function(xhr,errmsg,err) {
        console.log(xhr.status + ": " + xhr.responseText); 
      }
    });
  });
    }
  </script>


  <script>
    function editKnowledge(knowledge_id){
      var editknowledgeUrl = '/api/bots/{{ bot.id }}/knowledges/'+knowledge_id + '/';
      var botId = '{{ bot.id }}'
      function getCookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie != '') {
          var cookies = document.cookie.split(';');
          for (var i = 0; i < cookies.length; i++) {
            var cookie = jQuery.trim(cookies[i]);
            if (cookie.substring(0, name.length + 1) == (name + '=')) {
              cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
              break;
            }
          }
        }
        return cookieValue;
      }

      $("#editknowledgeForm"+knowledge_id).on('submit', function(e) {
        e.preventDefault();

        var csrftoken = getCookie('csrftoken');

        function csrfSafeMethod(method) {
      // these HTTP methods do not require CSRF protection
      return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
    }

    $.ajaxSetup({
      beforeSend: function(xhr, settings) {
        if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
          xhr.setRequestHeader("X-CSRFToken", csrftoken);
        }
      }
    });

    var question = $('#editedquestion'+knowledge_id).val();
    var answer = $('#editedanswer'+knowledge_id).val();
    var params = {
      csrfmiddlewaretoken : csrftoken, 
      statement: "" + question, 
      answer: "" + answer, 
      bot: botId
    };
    console.log(params);
    $.ajax({
      type : 'PUT',
      url : editknowledgeUrl,
      data : JSON.stringify(params),
      contentType: 'application/json',
      success : function(json) {
        alert('Query was successfully Edited!');
        window.location = '/bot/' + botId;
      },
      error : function(xhr,errmsg,err) {
        console.log(xhr.status + ": " + xhr.responseText); 
      }
    });
  });
    }
  </script>


  <script>
    function deleteKnowledge(knowledge_id){
      var deleteknowledgeUrl = '/api/bots/{{ bot.id }}/knowledges/' + knowledge_id + '/'
      if (confirm('Are you sure you want to delete this knowledge?')){
        $.ajax({
          type: 'DELETE',
          url: deleteknowledgeUrl,
          contentType: 'application/json',
          beforeSend: function (xhr) {
            xhr.setRequestHeader("X-CSRFToken", '{{ csrf_token }}');
          },
          success : function(json) {
            alert('Knowledge was successfully Deleted!');
            window.location = '/bot/{{ bot.id }}';
          },
          error : function(xhr,errmsg,err) {
            console.log(xhr.status + ": "); 
          }
        });
      }
    }
  </script>


  <script>
    var addknowledgeUrl = '/api/bots/{{ bot.id }}/knowledges/';
    var botId = '{{ bot.id }}'
    function getCookie(name) {
      var cookieValue = null;
      if (document.cookie && document.cookie != '') {
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
          var cookie = jQuery.trim(cookies[i]);
          if (cookie.substring(0, name.length + 1) == (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }

    $("#addknowledgeForm").on('submit', function(e) {
      e.preventDefault();

      var csrftoken = getCookie('csrftoken');

      function csrfSafeMethod(method) {
      // these HTTP methods do not require CSRF protection
      return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
    }

    $.ajaxSetup({
      beforeSend: function(xhr, settings) {
        if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
          xhr.setRequestHeader("X-CSRFToken", csrftoken);
        }
      }
    });

    var question = $('#question').val();
    var answer = $('#answer').val();
    var params = {
      csrfmiddlewaretoken : csrftoken, 
      statement: "" + question, 
      answer: "" + answer, 
      bot: botId
    };

    $.ajax({
      type : 'POST',
      url : addknowledgeUrl,
      data : JSON.stringify(params),
      contentType: 'application/json',
      success : function(json) {
        alert('Query was added Successfully!');
        window.location = '/bot/' + botId;
      },
      error : function(xhr,errmsg,err) {
        console.log(xhr.status + ": " + xhr.responseText); 
      }
    });
  });
</script>
{% endblock %}